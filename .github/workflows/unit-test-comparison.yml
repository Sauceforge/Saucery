name: Unit Test Comparison

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

env:
  ARTIFACT_NAME: build-artifacts
  BUILD_ARTIFACTS: ${{ github.workspace }}/build_artifacts
  SAUCE_USER_NAME: ${{ secrets.SAUCE_USER_NAME }}
  SAUCE_API_KEY: ${{ secrets.SAUCE_API_KEY }}

jobs:
  build:
    name: Build and upload artifact
    runs-on: ubuntu-latest
    outputs:
      artifact-name: build-artifacts
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 10 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      # Include project files and compiled outputs so downstream jobs can run without rebuilding.
      - name: Upload compiled binaries and project files
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            **/*.csproj
            **/bin/Release/**

  run-tunit:
    name: Run TUnit Tests
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Create artifact folder
        run: mkdir -p "${{ env.BUILD_ARTIFACTS }}"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ${{ env.BUILD_ARTIFACTS }}

      - name: Locate Saucery.Core.Tests project
        run: |
          set -e
          EXPECTED="${{ env.BUILD_ARTIFACTS }}/Saucery.Core.Tests/Saucery.Core.Tests.csproj"
          if [ -f "$EXPECTED" ]; then
            echo "Found project at expected path: $EXPECTED"
            PROJECT_PATH="$EXPECTED"
          else
            echo "Expected path not present, searching under ${{ env.BUILD_ARTIFACTS }}..."
            PROJECT_PATH=$(find "${{ env.BUILD_ARTIFACTS }}" -type f -name "Saucery.Core.Tests.csproj" -print -quit || true)
            if [ -n "$PROJECT_PATH" ]; then
              echo "Found project at: $PROJECT_PATH"
            else
              echo "Project Saucery.Core.Tests not found under ${{ env.BUILD_ARTIFACTS }}"
              ls -la "${{ env.BUILD_ARTIFACTS }}" || true
              exit 2
            fi
          fi
          echo "Using project: $PROJECT_PATH"
          echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV

      - name: Run TUnit Tests
        run: |
          set -e
          PROJECT_PATH="${{ env.PROJECT_PATH }}"
          OUT_ROOT="$(dirname "$PROJECT_PATH")/bin/Release"
          EXE_PATH=$(find "$OUT_ROOT" -type f -name "Saucery.Core.Tests" -print -quit || true)
          DLL_PATH=$(find "$OUT_ROOT" -type f -name "Saucery.Core.Tests.dll" -print -quit || true)

          if [ -n "$EXE_PATH" ]; then
            echo "Native executable found: $EXE_PATH"
            chmod +x "$EXE_PATH"
            BIN_DIR="$(dirname "$EXE_PATH")"
          elif [ -n "$DLL_PATH" ]; then
            echo "DLL found: $DLL_PATH"
            BIN_DIR="$(dirname "$DLL_PATH")"
          else
            echo "No built test output found under $OUT_ROOT"
            ls -la "$OUT_ROOT" || true
            exit 2
          fi

          echo "Changing working directory to: $BIN_DIR"
          cd "$BIN_DIR"

          echo "Running tests with dotnet run (project: $PROJECT_PATH)"
          dotnet run --project "$PROJECT_PATH" --configuration Release --no-build

  test-xunit:
    name: Run XUnit Tests
    needs: run-tunit
    runs-on: ubuntu-latest
    steps:
      - name: Create artifact folder
        run: mkdir -p "${{ env.BUILD_ARTIFACTS }}"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ${{ env.BUILD_ARTIFACTS }}

      - name: Run Saucery.Core.Tests.XUnit with dotnet test (no build)
        run: |
          set -e
          ART_DIR="${{ env.BUILD_ARTIFACTS }}"
          EXPECTED="$ART_DIR/Saucery.Core.Tests.XUnit/Saucery.Core.Tests.XUnit.csproj"
          if [ -f "$EXPECTED" ]; then
            PROJECT_PATH="$EXPECTED"
          else
            echo "Expected path not present, searching under $ART_DIR..."
            ls -la "$ART_DIR" || true
            PROJECT_PATH=$(find "$ART_DIR" -type f -name "Saucery.Core.Tests.XUnit.csproj" -print -quit || true)
          fi

          if [ -z "$PROJECT_PATH" ]; then
            echo "Project not found: $ART_DIR"
            ls -la "$ART_DIR" || true
            exit 2
          fi

          echo "Running dotnet test on: $PROJECT_PATH"
          dotnet test "$PROJECT_PATH" --configuration Release --no-build --nologo

  test-xunitv3:
    name: Run XUnitv3 Tests
    needs: test-xunit
    runs-on: ubuntu-latest
    steps:
      - name: Create artifact folder
        run: mkdir -p "${{ env.BUILD_ARTIFACTS }}"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ${{ env.BUILD_ARTIFACTS }}

      - name: Run Saucery.Core.Tests.XUnitv3 with dotnet test (no build)
        run: |
          set -e
          ART_DIR="${{ env.BUILD_ARTIFACTS }}"
          EXPECTED="$ART_DIR/Saucery.Core.Tests.XUnitv3/Saucery.Core.Tests.XUnitv3.csproj"
          if [ -f "$EXPECTED" ]; then
            PROJECT_PATH="$EXPECTED"
          else
            echo "Expected path not present, searching under $ART_DIR..."
            ls -la "$ART_DIR" || true
            PROJECT_PATH=$(find "$ART_DIR" -type f -name "Saucery.Core.Tests.XUnitv3.csproj" -print -quit || true)
          fi

          if [ -z "$PROJECT_PATH" ]; then
            echo "Project not found: $ART_DIR"
            ls -la "$ART_DIR" || true
            exit 2
          fi

          echo "Running dotnet test on: $PROJECT_PATH"
          dotnet test "$PROJECT_PATH" --configuration Release --no-build --nologo

  test-nunit:
    name: Run NUnit Tests
    needs: test-xunitv3
    runs-on: ubuntu-latest
    steps:
      - name: Create artifact folder
        run: mkdir -p "${{ env.BUILD_ARTIFACTS }}"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: ${{ env.BUILD_ARTIFACTS }}

      - name: Run Saucery.Core.Tests.NUnit with dotnet test (no build)
        run: |
          set -e
          ART_DIR="${{ env.BUILD_ARTIFACTS }}"
          EXPECTED="$ART_DIR/Saucery.Core.Tests.NUnit/Saucery.Core.Tests.NUnit.csproj"
          if [ -f "$EXPECTED" ]; then
            PROJECT_PATH="$EXPECTED"
          else
            echo "Expected path not present, searching under $ART_DIR..."
            ls -la "$ART_DIR" || true
            PROJECT_PATH=$(find "$ART_DIR" -type f -name "Saucery.Core.Tests.NUnit.csproj" -print -quit || true)
          fi

          if [ -z "$PROJECT_PATH" ]; then
            echo "Project not found: $ART_DIR"
            ls -la "$ART_DIR" || true
            exit 2
          fi

          echo "Running doten